<div class="max-w-5xl mx-auto px-4 py-8" data-controller="cart">
  <h1 class="text-2xl font-bold mb-6">ðŸ“¦ Lista de Produtos</h1>

  <% @lots.group_by(&:product).each do |product, lots| %>
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">ðŸ”’ Produto: <%= product.name %>
      </h2>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <% lots.each do |lot| %>
          <div class="border rounded-lg p-4 shadow bg-white">
            <p><strong>ID do Lote:</strong>
              <%= lot.id %>
            </p>
            <p><strong>Quantidade:</strong>
              <%= lot.quantity %> unidades
            </p>
            <p><strong>Validade:</strong> <span class="text-green-600">
                <%= lot.expiration_date %>
              </span></p>

            <div class="mt-3">
              <input type="number" min="1" max="<%= lot.quantity %>"
                class="quantity-input border rounded p-1 w-full mb-2" placeholder="Quantidade" />
              <button class="add-to-cart bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 w-full"
                data-lot-id="<%= lot.id %>" data-product-name="<%= product.name %>"
                data-expiration="<%= lot.expiration_date %>">
                Adicionar ao Pedido
              </button>
            </div>
          </div>
          <% end %>
      </div>
    </div>
    <% end %>

      <!-- Lista de produtos adicionados -->
      <div class="mt-10">
        <h2 class="text-xl font-bold mb-3">ðŸ›’ Itens Selecionados</h2>
        <ul id="cart-list" class="space-y-2 bg-gray-100 p-4 rounded"></ul>

        <%= form_with url: order_orders_lots_path(@order), method: :post, local: true, id: "order-lots-form" , data: {
          order_id: @order.id } do %>
          <div id="order-lots-fields"></div>
          <button type="submit"
            class="text-sm px-4 py-2 border border-indigo-500 text-indigo-600 rounded hover:bg-indigo-50 transition"
            title="Adicionar ao pedido">
            <i class="fas fa-edit mr-1"></i> Adicionar ao pedido
          </button>
        <% end %>

      </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const cart = [];
    const cartList = document.getElementById("cart-list");

    document.querySelectorAll(".add-to-cart").forEach(button => {
      button.addEventListener("click", () => {
        const lotId = button.dataset.lotId;
        const productName = button.dataset.productName;
        const expiration = button.dataset.expiration;
        const quantityInput = button.previousElementSibling;
        const quantity = parseInt(quantityInput.value);

        if (!quantity || quantity <= 0) {
          alert("Informe uma quantidade vÃ¡lida.");
          return;
        }

        cart.push({ lotId, productName, quantity, expiration });

        const item = document.createElement("li");
        item.textContent = `${quantity} unidade(s) do produto "${productName}" (lote ${lotId}, validade ${expiration})`;
        cartList.appendChild(item);

        quantityInput.value = "";
      });
    });

    document.getElementById("order-lots-form").addEventListener("submit", (e) => {
      e.preventDefault();

      const fieldsContainer = document.getElementById("order-lots-fields");
      fieldsContainer.innerHTML = "";

      cart.forEach(item => {
        // Campo lot_id
        const lotIdInput = document.createElement("input");
        lotIdInput.type = "hidden";
        lotIdInput.name = `order_lots[][lot_id]`;
        lotIdInput.value = item.lotId;
        fieldsContainer.appendChild(lotIdInput);

        // Campo quantity
        const quantityInput = document.createElement("input");
        quantityInput.type = "hidden";
        quantityInput.name = `order_lots[][quantity]`;
        quantityInput.value = item.quantity;
        fieldsContainer.appendChild(quantityInput);
      });

      e.target.submit();
    });


  });
</script>